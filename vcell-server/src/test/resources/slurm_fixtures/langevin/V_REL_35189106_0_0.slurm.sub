#!/usr/bin/bash
#SBATCH --partition=vcell
#SBATCH --reservation=
#SBATCH --qos=vcell
#SBATCH -J V_REL_35189106_0_0
#SBATCH -o /share/apps/vcell3/htclogs/V_REL_35189106_0_0.slurm.log
#SBATCH -e /share/apps/vcell3/htclogs/V_REL_35189106_0_0.slurm.log
#SBATCH --ntasks=20
#SBATCH --cpus-per-task=1
#SBATCH --mem-per-cpu=2048M
#SBATCH --nodes=1
#SBATCH --time=24:00:00
#SBATCH --no-kill
#SBATCH --no-requeue

set -o errexit
set -o pipefail
set -o nounset

# ------------------------------------------------------------------
# Universal generated preamble (keep exactly as produced by generator)
# ------------------------------------------------------------------
TMPDIR=/scratch/vcell
if [ ! -e $TMPDIR ]; then mkdir -p $TMPDIR ; fi
echo `hostname`
export MODULEPATH=/isg/shared/modulefiles:/tgcapps/modulefiles
source /usr/share/Modules/init/bash
module load singularity/vcell-3.10.0
export SINGULARITY_CACHEDIR=/share/apps/vcell3/singularity/cachdir
export SINGULARITY_PULLFOLDER=/share/apps/vcell3/singularity/pullfolder
echo "job running on host `hostname -f`"
echo "id is `id`"
echo ENVIRONMENT
env

container_bindings="--bind /share/apps/vcell3/users:/simdata "
container_bindings+="--bind /share/apps/vcell7/users:/simdata_secondary "
container_bindings+="--bind /share/apps/vcell12/users:/share/apps/vcell12/users "
container_bindings+="--bind /share/apps/vcell3/htclogs:/htclogs "
container_bindings+="--bind /scratch/vcell:/solvertmp "

container_env="--env java_mem_Xmx=1800M "
container_env+="--env jmshost_sim_internal=rke-wn-01.cam.uchc.edu "
container_env+="--env jmsport_sim_internal=31618 "
container_env+="--env jmsrestport_sim_internal=30163 "
container_env+="--env jmsuser=clientUser "
container_env+="--env jmspswd=dummy "
container_env+="--env jmsblob_minsize=100000 "
container_env+="--env mongodbhost_internal=rke-wn-01.cam.uchc.edu "
container_env+="--env mongodbport_internal=30019 "
container_env+="--env mongodb_database=test "
container_env+="--env primary_datadir_external=/share/apps/vcell3/users "
container_env+="--env secondary_datadir_external=/share/apps/vcell7/users "
container_env+="--env htclogdir_external=/share/apps/vcell3/htclogs "
container_env+="--env softwareVersion=Rel_Version_7.6.0_build_28 "
container_env+="--env serverid=REL "

solver_docker_name=ghcr.io/virtualcell/vcell-batch:7.6.0.43
batch_docker_name=ghcr.io/virtualcell/vcell-batch:7.6.0.43
# ------------------------------------------------------------------

# Script-controlled variables (populated by generator in real use)
USERID=danv
SIM_ID=35189106
TOTAL_JOBS=10            # to be set by generator to lso.getTotalNumberOfJobs()
TIMEOUT_SECONDS=300      # per-job timeout (seconds), adjust per generator
LOG_FILE="/share/apps/vcell3/htclogs/${SLURM_JOB_NAME}_${SLURM_JOB_ID}_submit.log"

mkdir -p /share/apps/vcell3/htclogs
echo "Job Execution Log" > "${LOG_FILE}"
echo "------------------" >> "${LOG_FILE}"
echo "=== [$(date)] === SLURM job ${SLURM_JOB_ID} started on $(hostname)" | tee -a "${LOG_FILE}"

# Preprocessor XML path (per-user)
SIMXML="/simdata/${USERID}/SimID_${SIM_ID}_0__0.simtask.xml"

echo "[Preprocess] Running JavaPreprocessor64 ${SIMXML}" | tee -a "${LOG_FILE}"
${batch_docker_name:+} # placeholder to maintain generated code context

# run JavaPreprocessor64 inside batch container (use generated batch prefix)
${batch_container_prefix:-"singularity run --containall ${container_bindings} ${container_env} docker://${batch_docker_name}"} JavaPreprocessor64 "${SIMXML}" "/simdata/${USERID}" >> "${LOG_FILE}" 2>&1
stat=$?
echo "JavaPreprocessor64 returned ${stat}" | tee -a "${LOG_FILE}"
if [ $stat -ne 0 ]; then
  ${batch_container_prefix:-"singularity run --containall ${container_bindings} ${container_env} docker://${batch_docker_name}"} JavaPostprocessor64 "${SIM_ID}" "${USERID}" 17 0 0 $stat "${HTC_LOG_DIR_EXTERNAL:-/share/apps/vcell3/htclogs}/${SLURM_JOB_NAME}.slurm.sub" >> "${LOG_FILE}" 2>&1 || true
  echo "Preprocessor failed; exiting ${stat}" | tee -a "${LOG_FILE}"
  exit $stat
fi

# ------------------------------------------------------------------
# Preserve original concurrency / PID-tracking logic exactly as requested
# Inputs and solver logs are per-user under /simdata/${USERID}
# ------------------------------------------------------------------
INPUT_DIR="/simdata/${USERID}"
LOG_DIR="/simdata/${USERID}"   # solver writes logs here per your specification
declare -A job_pid_map
job_pids=()
running_jobs=0
any_fail=0
max_concurrent_jobs=${SLURM_NTASKS:-20}

for i in $(seq 0 $((TOTAL_JOBS - 1))); do
    echo "Job $i started at $(date)" >> "${LOG_FILE}"

    timeout "${TIMEOUT_SECONDS}s" srun -N 1 -n 1 -c 1 \
      singularity exec --containall \
        ${container_bindings} \
        ${container_env} \
        docker://${solver_docker_name} \
        langevin_x64 simulate \
          "${INPUT_DIR}/SimID_${SIM_ID}_0_.langevinInput" \
          ${i} \
          --output-log="${LOG_DIR}/SimID_${SIM_ID}_0_${i}.log" \
          --vc-print-status &

    pid=$!
    job_pids+=($pid)
    job_pid_map[$pid]=$i
    ((running_jobs++))

    # throttle: wait for a finished job before launching a new one when concurrency limit hit
    while (( running_jobs >= max_concurrent_jobs )); do
        for idx in "${!job_pids[@]}"; do
            pid="${job_pids[$idx]}"
            if [[ -z "${pid}" ]]; then
                continue
            fi
            if ! kill -0 "$pid" 2>/dev/null; then
                wait "$pid"
                exit_code=$?
                job_index=${job_pid_map[$pid]:-unknown}
                echo "Job $job_index with PID $pid finished with exit code $exit_code at $(date)" >> "${LOG_FILE}"
                unset "job_pids[$idx]"
                unset "job_pid_map[$pid]"
                ((running_jobs--))
                if [[ $exit_code -ne 0 ]]; then
                    any_fail=1
                fi
                break
            fi
        done
        sleep 1
    done
done

# final wait for any remaining jobs
for pid in "${job_pids[@]}"; do
    if [[ -z "${pid}" ]]; then
        continue
    fi
    wait "$pid"
    exit_code=$?
    job_index=${job_pid_map[$pid]:-unknown}
    echo "Job $job_index with PID $pid finished with exit code $exit_code at $(date)" >> "${LOG_FILE}"
    if [[ $exit_code -ne 0 ]]; then
        any_fail=1
    fi
done
echo "Batch jobs completed at $(date)" >> "${LOG_FILE}"

# postprocess solver invocation (runs after all simulations finish)
echo "Starting the last job (postprocess) at $(date)" >> "${LOG_FILE}"
timeout "${TIMEOUT_SECONDS}s" srun -N 1 -n 1 -c 1 \
  singularity exec --containall \
    ${container_bindings} \
    ${container_env} \
    docker://${solver_docker_name} \
    langevin_x64 postprocess \
      "${INPUT_DIR}/SimID_${SIM_ID}_0_.langevinInput" \
      ${TOTAL_JOBS} \
      --output-log="${LOG_DIR}/SimID_${SIM_ID}_0_P.log" \
      --vc-print-status &

last_pid=$!
wait $last_pid
exit_code=$?
echo "Job 'Last' with PID $last_pid finished with exit code $exit_code at $(date)" >> "${LOG_FILE}"
echo "The final job finished at $(date)" >> "${LOG_FILE}"
echo "All jobs completed at $(date)" >> "${LOG_FILE}"

# Run JavaPostprocessor64 inside batch container
echo "[Postprocess] Running JavaPostprocessor64..." | tee -a "${LOG_FILE}"
${batch_container_prefix:-"singularity run --containall ${container_bindings} ${container_env} docker://${batch_docker_name}"} JavaPostprocessor64 "${SIM_ID}" "${USERID}" 17 0 0 "${TOTAL_JOBS}" "${HTC_LOG_DIR_EXTERNAL:-/share/apps/vcell3/htclogs}/${SLURM_JOB_NAME}.slurm.sub" >> "${LOG_FILE}" 2>&1
post_exit=$?

# final exit decision
if [[ "${any_fail}" -ne 0 ]]; then
  echo "One or more simulation tasks failed; exiting non-zero" | tee -a "${LOG_FILE}"
  exit 1
fi

if [[ "${post_exit}" -ne 0 ]]; then
  echo "JavaPostprocessor64 failed with ${post_exit}; exiting ${post_exit}" | tee -a "${LOG_FILE}"
  exit "${post_exit}"
fi

echo "=== [$(date)] === SLURM job completed successfully" | tee -a "${LOG_FILE}"
exit 0
