# vcell-batch-job


This project supports the execution of Virtual Cell (VCell) simulations inside a containerized environment using Apptainer (formerly Singularity) on a Linux system hosted via WSL on Windows 10. This setup does not support slurm.

---

## 🖥️ Environment Setup

### 1. Install WSL (Windows Subsystem for Linux)

1. Open **PowerShell as Administrator**.
2. Run:
   ```powershell
   wsl --install -d Ubuntu
   ```
   If you encounter issues:
   ```powershell
   dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
   dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
   wsl --update
   wsl --install -d Ubuntu
   ```
3. Restart windows when prompted

### 2. Launch Ubuntu

   Open the Ubuntu app from the Windows Start Menu.

   You’ll land in a Linux terminal prompt:
   ```powershell
   vasilescu@oci:~$
   ```

To maintain visibility between File Explorer and Ubuntu's /home/vasilescu, paste \
this in the File Explorer address bar.
```powershell
\\wsl$\Ubuntu\home\vasilescu\vcell-batch-job
```


### 3. Installing Appteiner

1. Update packages and install dependencies
```powershell
sudo apt update && sudo apt install -y \
build-essential wget git cryptsetup runc uidmap squashfs-tools \
fuse-overlayfs libseccomp-dev pkg-config libglib2.0-dev libfuse2
```
2. Download and install Apptainer:
```powershell
export VERSION=1.3.0
wget https://github.com/apptainer/apptainer/releases/download/v${VERSION}/apptainer_${VERSION}_amd64.deb
sudo apt install ./apptainer_${VERSION}_amd64.deb
```
3. Verify installation
   ```powershell
   apptainer version
   ```

### 4. Project directory structure

```powershell
vcell-batch-job/
├── archive/       # Archived or versioned Slurm scripts
├── container/     # Apptainer images (e.g., vcell-batch-7.7.0.27.sif)
├── input/         # Input files (e.g., .simtask.xml, .langevinInput)
├── logs/          # Logs generated by Slurm .slurm.sub scripts
├── output/        # Simulation outputs (e.g., solver logs)
├── scripts/       # Active Slurm submission scripts and helpers
```
To scaffold this layout run:
```powershell
mkdir -p vcell-batch-job/{archive,container,input,logs,output,scripts}
cp vcell-batch_*.sif vcell-batch-job/container/
```

### 5. Container pulling and versioning.

I need to run apptainer from within the Ubuntu shell on the local machine
since it is not available on mantis. \
Remember the special file directory is different than the one on Windows, paste 
the following in the File Explorer address bar:
> \\wsl$\Ubuntu\home\vasilescu\vcell-batch-job

Set environment variables for GitHub Container Registry access:
```powershell
export APPTAINER_DOCKER_USERNAME=<your_github_username>
export APPTAINER_DOCKER_PASSWORD=<your_github_personal_access_token>
```
You'll need a  ghcr login token
```powershell
On my machine, they are stored in 
Z:/.ssh/ghcr_login_token
```

Pull the desired container image:
```powershell
apptainer pull vcell-batch-7.7.0.27.sif docker://ghcr.io/virtualcell/vcell-batch:7.7.0.27
```

> All container images are saved under **container/** using versioned filenames \
> (e.g., vcell-batch-7.7.0.27.sif, vcell-batch-7.7.0.28.sif)


### 6 On a HPC node - using slurm
Login to a HPC node
```powershell
ssh vasilescu@login.hpc.cam.uchc.edu
ssh vasilescu@mantis-040
```

We assume that everything is installed properly, like above. \
Root directory:
> Z: ⇔ /home/FCAM/vasilescu
```powershell
BASE_DIR=$HOME/vcell-batch-job
mkdir -p $BASE_DIR/{input,output,logs,scripts,container}
```

Frequently used, from BASE_DIR
```powershell
sed -i 's/\r$//' ./scripts/submit_vcell_batch.slurm.sub
tail -f ./logs/submit_vcell_batch.log
singularity exec ./container/vcell-batch_7.7.0.28.sif java --version    # java version
singularity shell ./container/vcell-batch_7.7.0.28.sif                  # enter singularity
```
#### Initialize directory structure
```powershell
./populate_vcell_batch.sh
```

#### Running the solver inside the container
```powershell
singularity exec ./container/vcell-batch_7.7.0.28.sif langevin_x64 --version
```

#### Launching a slurm script
```powershell
sbatch ./scripts/submit_vcell_batch.slurm.sub
```

Github Repository - configuration stuff
```powershell
https://github.com/virtualcell/vcell-fluxcd/
https://github.com/virtualcell/vcell-fluxcd/blob/main/kustomize/config/prod/
submit.env        # all definitions for slurm, docker, dirs
```
Logs - on linux machines, ex mantis-040
```powershell
/share/apps/vcell3/htclogs

> less V_REL_292453752_0_0.slurm.sub   # shows top of the script (the definitions) \
> ls -ot V_REL* | head                 # shows a few of the most recent release sims
```

### 7 Data to use for development (in the TEMP/slurm-test-inputs directory)

#### KEEP subdir
Complex springsalad model with a transition and a binding reaction \
Duration about 10 minutes \
Results of 8 manual runs, slightly different results due to stochasticity \
Should be used to test the advanced statistics logic in the solver

#### proof-of-concept subdir
slurm script to run X trials, Y at a time

#### simdata-keep subdir
very fast springsalad model with one binding reaction \

its content is replicated in repository files:
> SimID_999999999_0_.langevinInput \
> SimID_999999999_0__0.simtask.xml

here we also have the full results of one run

##### Important note about the xml file
variables of interest for multiple runs under slurm, in containers, are:
```powershell
<LangevinSimulationOptions>
   ....
   <NumOfParallelRuns>8</NumOfParallelRuns>
   <NumBatchTrials>20</NumBatchTrials>
</LangevinSimulationOptions>
```
