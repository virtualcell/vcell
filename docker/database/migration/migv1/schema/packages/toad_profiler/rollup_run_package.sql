-- Generated by Ora2Pg, the Oracle database Schema converter, version 24.3
-- Copyright 2000-2024 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=vcell-oracle.cam.uchc.edu;service_name=ORCLPDB1;port=1521

SET client_encoding TO 'UTF8';
SET search_path = vcell,toad_profiler,public;




  -- rollup all units for the given run
CREATE OR REPLACE PROCEDURE toad_profiler.rollup_run (run_number bigint) AS $body$
DECLARE

    tabpos bigint;
    comment varchar(2047);
    proc varchar(256);
    --
    -- only select those units which have not been rolled up yet
    cunits CURSOR(run_number bigint) FOR
      SELECT unit_number, unit_type, unit_owner, unit_name
        from plsql_profiler_units
        where runid = run_number and total_time = 0
        order by unit_number asc;

BEGIN
    -- Fix Oracle's calling a 'PACKAGE' a 'PACKAGE SPEC'
    update plsql_profiler_units set unit_type = 'PACKAGE'
    where runid = run_number and unit_type like 'PACKAGE SPEC%';

    -- parse the RUN_COMMENT column to get the procedure name
  	-- (note: this replaces the BI_PLSQL_PROFILER_RUNS trigger.
    select run_proc, run_comment into STRICT proc, comment
	  from plsql_profiler_runs where runid = run_number;
    if proc is null then
      tabpos := position(CHR(8) in comment);
        if tabpos > 0 THEN
          proc := SUBSTR(comment, tabpos+1);
          comment := SUBSTR(comment, 1, tabpos-1);
        else
          proc := 'ANONYMOUS BLOCK';
        end if;
        update plsql_profiler_runs
          set run_owner = USER, run_proc = proc, run_comment = comment
          where runid = run_number;
    end if;


    for unitrec in cunits(run_number) loop
      toad_profiler.rollup_unit(run_number, unitrec.unit_number, unitrec.unit_type,
                  unitrec.unit_owner, unitrec.unit_name);
    end loop;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE toad_profiler.rollup_run (run_number bigint) FROM PUBLIC;
